<!DOCTYPE html>
<html lang="th" data-theme="studio-blue">
<head>
  <meta charset="utf-8" />
  <!-- ‡∏Ñ‡∏á‡∏Ñ‡πà‡∏≤ viewport ‡πÄ‡∏î‡∏¥‡∏° ‡πÅ‡∏•‡∏∞‡∏£‡∏≠‡∏á‡∏£‡∏±‡∏ö safe area -->
  <meta name="viewport" content="width=device-width, initial-scale=1, maximum-scale=1, viewport-fit=cover" />
  <meta name="theme-color" content="#1a202c" />
  <meta name="apple-mobile-web-app-capable" content="yes">
  <meta name="apple-mobile-web-app-status-bar-style" content="black-translucent">
  <title>Mobile RTA (Pro)</title>

  <style>
    /* ====== Themes (‡πÄ‡∏´‡∏°‡∏∑‡∏≠‡∏ô‡πÄ‡∏î‡∏¥‡∏°) ====== */
    :root, [data-theme="dark-matter"]{
      --bg1:#1a202c; --bg2:#1a202c; --card:#2d3748; --text:#cbd5e1; --muted:#718096;
      --gridH:rgba(255,255,255,.08); --gridV:rgba(255,255,255,.04);
      --frame:rgba(255,255,255,1); --label:rgba(255,255,255,.85);
      --fft:#68d391; --peak:#b794f4; --hold:#f6ad55; --bar:#68d391;
      --heatmap-color-1:#1a202c; --heatmap-color-2:#4a5568; --heatmap-color-3:#68d391;
      --heatmap-color-4:#f6ad55; --heatmap-color-5:#e53e3e;
      --dba-meter-bg-green:#48bb78; --dba-meter-bg-yellow:#f6ad55;
      --dba-meter-bg-orange:#ed8936; --dba-meter-bg-red:#e53e3e;
      --accent-color:#2DD4BF;

      --select-bg:rgba(0,0,0,.28);
      --select-bg-hover:rgba(255,255,255,.06);
      --select-border:rgba(255,255,255,.14);
      --select-border-focus:rgba(45,212,191,.65);
      --select-shadow:0 2px 8px rgba(0,0,0,.35) inset, 0 0 0 0 rgba(0,0,0,0);
      --select-shadow-focus:0 0 0 2px rgba(45,212,191,.25);
    }
    [data-theme="studio-blue"]{
      --bg1:#0F172A; --bg2:#1E293B; --card:#1E293B; --text:#E2E8F0; --muted:#64748B;
      --gridH:rgba(255,255,255,.10); --gridV:rgba(255,255,255,.05);
      --frame:rgba(255,255,255,.12); --label:rgba(255,255,255,.90);
      --fft:#22D3EE; --peak:#A5B4FC; --hold:#F472B6; --bar:#22D3EE;
      --heatmap-color-1:#0F172A; --heatmap-color-2:#334155; --heatmap-color-3:#0EA5E9;
      --heatmap-color-4:#A78BFA; --heatmap-color-5:#F472B6;
      --dba-meter-bg-green:#22D3EE; --dba-meter-bg-yellow:#A78BFA;
      --dba-meter-bg-orange:#EC4899; --dba-meter-bg-red:#F43F5E;
      --accent-color:#60A5FA;

      --select-bg:rgba(30,41,59,.55);
      --select-bg-hover:rgba(30,41,59,.75);
      --select-border:rgba(255,255,255,.16);
      --select-border-focus:rgba(96,165,250,.7);
      --select-shadow:0 2px 8px rgba(0,0,0,.35) inset, 0 0 0 0 rgba(0,0,0,0);
      --select-shadow-focus:0 0 0 2px rgba(96,165,250,.25);
    }
    [data-theme="vintage-amber"]{
      --bg1:#292524; --bg2:#1c1917; --card:#44403C; --text:#D6D3D1; --muted:#A8A29E;
      --gridH:rgba(255,250,235,.10); --gridV:rgba(255,250,235,.05);
      --frame:rgba(255,250,235,.12); --label:rgba(255,255,255,.90);
      --fft:#F59E0B; --peak:#FDE68A; --hold:#FDBA74; --bar:#F59E0B;
      --heatmap-color-1:#292524; --heatmap-color-2:#78716C; --heatmap-color-3:#F59E0B;
      --heatmap-color-4:#FBBF24; --heatmap-color-5:#EF4444;
      --dba-meter-bg-green:#F59E0B; --dba-meter-bg-yellow:#FACC15;
      --dba-meter-bg-orange:#FB923C; --dba-meter-bg-red:#EF4444;
      --accent-color:#D97706;

      --select-bg:rgba(0,0,0,.28);
      --select-bg-hover:rgba(255,255,255,.06);
      --select-border:rgba(255,250,235,.18);
      --select-border-focus:rgba(217,119,6,.7);
      --select-shadow:0 2px 8px rgba(0,0,0,.35) inset, 0 0 0 0 rgba(0,0,0,0);
      --select-shadow-focus:0 0 0 2px rgba(217,119,6,.25);
    }
    [data-theme="midnight-neon"]{
      --bg1:#0B0914; --bg2:#120F22; --card:#1C1933; --text:#D8D3F5; --muted:#7A759C;
      --gridH:rgba(220,210,255,.08); --gridV:rgba(220,210,255,.04);
      --frame:rgba(220,210,255,.12); --label:rgba(220,210,255,.90);
      --fft:#F43F5E; --peak:#0CF1E5; --hold:#FBBF24; --bar:#F43F5E;
      --heatmap-color-1:#0B0914; --heatmap-color-2:#3D3A63; --heatmap-color-3:#BE3887;
      --heatmap-color-4:#F43F5E; --heatmap-color-5:#FBBF24;
      --dba-meter-bg-green:#0CF1E5; --dba-meter-bg-yellow:#FBBF24;
      --dba-meter-bg-orange:#F43F5E; --dba-meter-bg-red:#f43f82;
      --accent-color:#0CF1E5;
    }
    [data-theme="emerald-gold"]{
      --bg1:#052016; --bg2:#0B3B2A; --card:#0F4D37; --text:#E6FFE9; --muted:#9FE3B2;
      --gridH:rgba(230,255,233,.10); --gridV:rgba(230,255,233,.05);
      --frame:rgba(230,255,233,.12); --label:rgba(230,255,233,.90);
      --fft:#34D399; --peak:#F59E0B; --hold:#EAB308; --bar:#34D399;
      --heatmap-color-1:#052016; --heatmap-color-2:#0B3B2A; --heatmap-color-3:#34D399;
      --heatmap-color-4:#F59E0B; --heatmap-color-5:#EF4444;
      --dba-meter-bg-green:#34D399; --dba-meter-bg-yellow:#EAB308;
      --dba-meter-bg-orange:#F59E0B; --dba-meter-bg-red:#EF4444;
      --accent-color:#10B981;
    }

    /* ====== Layout base (‡πÄ‡∏´‡∏°‡∏∑‡∏≠‡∏ô‡πÄ‡∏î‡∏¥‡∏°) ====== */
    html,body{height:100%;margin:0;background:var(--bg1);color:var(--text);-webkit-font-smoothing:antialiased;overflow:hidden;}
    *{box-sizing:border-box}
    .wrap{max-width:1200px;margin:0 auto;padding:10px 12px 24px;display:flex;flex-direction:column;gap:12px}
    .row{display:flex;gap:12px;align-items:center;flex-wrap:wrap}
    .card{background:var(--card);border:1px solid rgba(255,255,255,.08);border-radius:16px;padding:12px;box-shadow:0 6px 20px rgba(0,0,0,.2) inset}
    .plot{height:320px;position:relative;border:1px solid var(--frame);border-radius:12px;padding:8px 8px 8px 8px;overflow:hidden}
    canvas{width:100%;height:100%;display:block}
    .badges{display:flex;gap:6px;align-items:center}
    .badge{background:rgba(0,0,0,.25);border:1px solid rgba(255,255,255,.12);padding:4px 8px;border-radius:10px;font-size:12px}
    .hint{color:var(--muted);font-size:12px}

    /* ===== Toolbar & Controls (‡πÄ‡∏´‡∏°‡∏∑‡∏≠‡∏ô‡πÄ‡∏î‡∏¥‡∏°) ===== */
    .toolbar{display:flex;align-items:center;gap:12px}
    .toolbar .stack{display:flex;align-items:center;gap:8px}
    .toolbar label{display:flex;align-items:center;gap:8px;font-size:12px;color:var(--muted)}
    .toolbar input[type="range"]{width:140px;vertical-align:middle}
    .icon-btn{width:36px;height:32px;padding:0;display:inline-flex;align-items:center;justify-content:center;border-radius:10px;font-size:16px;line-height:1;background:rgba(0,0,0,.2);border:1px solid rgba(255,255,255,.12);color:var(--text)}
    .icon-btn svg{width:20px;height:20px;pointer-events:none;display:block}
    .icon-btn[data-active="1"]{outline:1px solid rgba(255,255,255,.18)}
    @media (max-width:480px){.toolbar input[type="range"]{width:110px}.icon-btn{width:34px;height:30px}}

    button,select,input[type=range],input[type=number]{-webkit-tap-highlight-color:transparent}
    button{background:var(--accent-color);border:none;color:white;padding:10px 14px;border-radius:12px;font-weight:700;cursor:pointer;transition:background-color .2s,opacity .2s}
    button:disabled{opacity:.5;cursor:not-allowed}
    button.secondary{background:rgba(0,0,0,.2)} button.ghost{background:rgba(0,0,0,.2)}
    label{font-size:12px;color:var(--muted)}
    select,input[type=number]{appearance:none;height:30px;min-width:0;padding:0 8px;border-radius:8px;background:var(--select-bg);color:var(--text);border:1px solid var(--select-border);box-shadow:var(--select-shadow);outline:none;transition:background .2s,border-color .2s,box-shadow .2s}
    select:hover,input[type=number]:hover{background:var(--select-bg-hover)}
    select:focus,input[type=number]:focus{border-color:var(--select-border-focus);box-shadow:var(--select-shadow-focus)}
    select:disabled,input[type=number]:disabled{opacity:.6;cursor:not-allowed}
    select{padding:0 24px 0 8px}
    select::-ms-expand{display:none}
    select option, select optgroup{background:var(--card);color:var(--text)}
    input[type=number]{-moz-appearance:textfield}
    input::-webkit-outer-spin-button,input::-webkit-inner-spin-button{-webkit-appearance:none;margin:0}

    /* ========= üîß ‡πÅ‡∏Å‡πâ‡∏ö‡∏±‡πä‡∏Å PWA Fullscreen / iPad Safe Area =========
       ‡πÄ‡∏î‡∏¥‡∏°‡πÉ‡∏ä‡πâ 100vh/100vw ‡πÅ‡∏•‡πâ‡∏ß canvas ‡∏´‡∏•‡∏∏‡∏î‡∏Ç‡∏≠‡∏ö‡∏Ç‡∏ß‡∏≤‡πÉ‡∏ô‡πÇ‡∏´‡∏°‡∏î‡∏™‡πÅ‡∏ï‡∏ô‡∏≠‡∏∞‡πÇ‡∏•‡∏ô
       ‡∏õ‡∏£‡∏±‡∏ö‡πÄ‡∏õ‡πá‡∏ô 100dvh/100dvw + env(safe-area-inset-*) ‡πÅ‡∏•‡∏∞‡∏ö‡∏±‡∏á‡∏Ñ‡∏±‡∏ö width/height ‡∏Ç‡∏≠‡∏á canvas
       ============================================================= */
    .card.is-fullscreen{
      position:fixed; inset:0; z-index:9999; margin:0; border-radius:0;
      width:100dvw; height:100dvh;               /* dynamic viewport units */
      padding-top:    max(env(safe-area-inset-top),0px);
      padding-right:  max(env(safe-area-inset-right),0px);
      padding-bottom: max(env(safe-area-inset-bottom),0px);
      padding-left:   max(env(safe-area-inset-left),0px);
      box-sizing:border-box;
      background:var(--card);
    }
    /* ‡∏Ñ‡∏ß‡∏≤‡∏°‡∏™‡∏π‡∏á‡∏™‡πà‡∏ß‡∏ô plot ‡∏Ç‡∏ì‡∏∞‡∏ü‡∏π‡∏•‡∏™‡∏Å‡∏£‡∏µ‡∏ô ‡∏ï‡πâ‡∏≠‡∏á‡∏´‡∏±‡∏Å safe-area ‡∏î‡πâ‡∏ß‡∏¢ */
    .card.is-fullscreen .plot{
      height:calc(100dvh - 120px - env(safe-area-inset-top) - env(safe-area-inset-bottom));
    }
    :fullscreen .plot{
      height:calc(100dvh - 120px - env(safe-area-inset-top) - env(safe-area-inset-bottom));
    }
    :fullscreen canvas,
    .card.is-fullscreen canvas{
      width:100% !important;
      height:100% !important;
    }

    /* Floating Dock (‡πÄ‡∏´‡∏°‡∏∑‡∏≠‡∏ô‡πÄ‡∏î‡∏¥‡∏°) */
    .float-dock-wrap{position:relative}
    .float-dock{position:fixed;right:16px;bottom:16px;display:flex;flex-direction:column;gap:8px;z-index:10000}
    .fab{width:56px;height:56px;border-radius:16px;background:rgba(0,0,0,.35);backdrop-filter:blur(6px);border:1px solid rgba(255,255,255,.16);color:var(--text);display:flex;align-items:center;justify-content:center;font-size:20px}
    .fab[disabled]{opacity:.5}

    /* Toast (‡πÄ‡∏´‡∏°‡∏∑‡∏≠‡∏ô‡πÄ‡∏î‡∏¥‡∏°) */
    .toast{position:fixed;left:50%;bottom:18px;transform:translateX(-50%);background:rgba(0,0,0,.7);color:#fff;padding:8px 12px;border-radius:10px;border:1px solid rgba(255,255,255,.18);font-size:14px;z-index:10001;display:none}

    /* Mobile landscape fullscreen fix (‡∏°‡∏µ‡∏≠‡∏¢‡∏π‡πà‡πÄ‡∏î‡∏¥‡∏°‚Äî‡∏Ñ‡∏á‡πÑ‡∏ß‡πâ) */
    @supports(padding: max(env(safe-area-inset-top),0px)){
      body{padding:0}
    }
  </style>
</head>
<body>
  <div class="wrap">
    <!-- Header / ‡∏Ñ‡∏ß‡∏ö‡∏Ñ‡∏∏‡∏°‡∏´‡∏•‡∏±‡∏Å -->
    <div class="card">
      <div class="row" style="justify-content:space-between">
        <div class="row">
          <button id="btnStart">Start Mic</button>
          <button id="btnStop" disabled>Stop</button>
          <button id="btnStartDemo" class="secondary">Demo</button>
          <button id="btnClear" class="secondary">Clear</button>
          <button id="btnHold" class="secondary" aria-pressed="true">üìå Hold Peak: ON</button>
          <button id="btnAweight" class="secondary" aria-pressed="false">A-weighting: OFF</button>
          <button id="btnResetDba" class="secondary">Reset dBA</button>
        </div>
        <div class="row">
          <label>Theme
            <select id="themeSelector">
              <option value="dark-matter">Dark Matter</option>
              <option value="studio-blue" selected>Studio Blue</option>
              <option value="vintage-amber">Vintage Amber</option>
              <option value="midnight-neon">Midnight Neon</option>
              <option value="emerald-gold">Emerald Gold</option>
            </select>
          </label>
        </div>
      </div>

      <div class="row" style="margin-top:8px">
        <label>Smoothing <input id="smoothing" type="range" min="0" max="0.95" step="0.01" value="0.75"></label>
        <label>Averaging <input id="avg" type="checkbox" checked></label>
      </div>

      <div class="row" style="justify-content:space-between">
        <div class="row">
          <label>‡∏û‡∏¢‡∏≤‡∏¢‡∏≤‡∏°‡∏õ‡∏¥‡∏î DSP ‡∏Ç‡∏≠‡∏á‡∏£‡∏∞‡∏ö‡∏ö:</label>
          <div class="row">
            <label>echoCancellation <input id="ec" type="checkbox" checked></label>
            <label>noiseSuppression <input id="ns" type="checkbox" checked></label>
            <label>autoGainControl <input id="agc" type="checkbox" checked></label>
          </div>
        </div>
      </div>
    </div>

    <!-- ====== ‡πÄ‡∏°‡∏ô‡∏ß‡∏±‡∏î‡∏ú‡∏• ====== -->
    <div class="meters">

      <!-- FFT -->
      <div class="card" id="fftCard">
        <div class="row" style="justify-content:space-between;align-items:center;">
          <div class="row">
            <b>FFT - </b>
            <select id="fftYScale">
              <option value="log" selected>Log</option>
              <option value="linear">Linear</option>
            </select>
          </div>
          <div class="badges">
            <span class="badge" id="fftPeakText">Peak: ‚Äî</span>
            <span class="badge" id="fftHoldText" style="display:none;">Hold: ‚Äî</span>
          </div>
          <div class="toolbar">
            <div class="stack">
              <label>FFT Size
                <input id="fftRangeSlider" type="range" min="0" max="3" step="1" value="1" aria-label="FFT size preset">
                <select id="fftSizePreset">
                  <option value="2048">2048</option>
                  <option value="4096" selected>4096</option>
                  <option value="8192">8192</option>
                  <option value="16384">16384</option>
                </select>
              </label>
              <label>Smooth <input id="fftRangeDummy" type="range" min="0" max="1" step="0.01" value="0.75"></label>
              <span class="hint">4096</span>
            </div>
            <button class="ghost icon-btn" id="fsFFT" title="Fullscreen" aria-label="Fullscreen">
              <svg viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2"
                   stroke-linecap="round" stroke-linejoin="round" aria-hidden="true">
                <path d="M3 9V5a2 2 0 0 1 2-2h4"/>
                <path d="M21 9V5a2 2 0 0 0-2-2h-4"/>
                <path d="M3 15v4a2 2 0 0 0 2 2h4"/>
                <path d="M21 15v4a2 2 0 0 1-2 2h-4"/>
              </svg>
            </button>
          </div>
        </div>
        <div class="plot">
          <canvas id="fftCanvas"></canvas>
          <div id="fftTip" class="tip" style="display:none">‚Äî</div>
        </div>
      </div>

      <!-- Octave -->
      <div class="card" id="octCard">
        <div class="row" style="justify-content:space-between;align-items:center;">
          <div class="row">
            <select id="octRes">
              <option value="3">1/3</option>
              <option value="6">1/6</option>
              <option value="12" selected>1/12</option>
              <option value="24">1/24</option>
            </select>
            <b>Oct</b>
          </div>
          <div class="badges">
            <span class="badge" id="octPeakText">Peak: ‚Äî</span>
            <span class="badge" id="octHoldText" style="display:none;">Hold: ‚Äî</span>
          </div>
          <div class="toolbar">
            <div class="stack">
              <label>Range
                <input id="octRangeSlider" type="range" min="64" max="1023" step="1" value="255" aria-label="Octave bar range">
                <select id="octRangePreset">
                  <option value="127">127</option>
                  <option value="255" selected>256</option>
                  <option value="511">512</option>
                </select>
              </label>
              <span class="hint" id="octRangeText">0‚Äì255</span>
            </div>
            <button class="ghost icon-btn" id="fsOct" title="Fullscreen" aria-label="Fullscreen">
              <svg viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2"
                   stroke-linecap="round" stroke-linejoin="round" aria-hidden="true">
                <path d="M3 9V5a2 2 0 0 1 2-2h4"/>
                <path d="M21 9V5a2 2 0 0 0-2-2h-4"/>
                <path d="M3 15v4a2 2 0 0 0 2 2h4"/>
                <path d="M21 15v4a2 2 0 0 1-2 2h-4"/>
              </svg>
            </button>
          </div>
        </div>
        <div class="plot">
          <canvas id="octCanvas"></canvas>
          <div id="octTip" class="tip" style="display:none">‚Äî</div>
        </div>
      </div>

      <!-- Spectrogram -->
      <div class="card" id="heatmapCard">
        <div class="row" style="justify-content:space-between;align-items:center;">
          <div class="row">
            <button id="btnToggleHeatmap" class="ghost" aria-pressed="false">OFF</button>
            <button id="btnHeatmapQuality" class="ghost" aria-pressed="true">HD</button>
          </div>
          <div class="badges">
            <span class="badge" id="heatmapAthText">ATH: ‚Äî</span>
            <button id="btnClearAth" class="ghost" style="font-size:12px;padding:4px 8px; margin-left:4px;">Clear</button>
          </div>
          <div class="toolbar">
            <div class="stack">
              <label>Range
                <input id="heatmapRangeSlider" type="range" min="15" max="80" step="1" value="50" aria-label="Heatmap range">
                <select id="heatmapRangePreset">
                  <option value="30">30</option>
                  <option value="50" selected>50</option>
                  <option value="70">70</option>
                </select>
              </label>
              <span class="hint" id="heatmapRangeText">-50 dBFS</span>
            </div>
            <button class="ghost icon-btn" id="fsHeat" title="Fullscreen" aria-label="Fullscreen">
              <svg viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2"
                   stroke-linecap="round" stroke-linejoin="round" aria-hidden="true">
                <path d="M3 9V5a2 2 0 0 1 2-2h4"/>
                <path d="M21 9V5a2 2 0 0 0-2-2h-4"/>
                <path d="M3 15v4a2 2 0 0 0 2 2h4"/>
                <path d="M21 15v4a2 2 0 0 1-2 2h-4"/>
              </svg>
            </button>
          </div>
        </div>
        <div class="plot">
          <canvas id="heatmapCanvas"></canvas>
          <div id="heatmapTip" class="tip" style="display:none">‚Äî</div>
        </div>
      </div>
    </div>

    <!-- dB Meter -->
    <div class="card">
      <div class="row" style="justify-content:space-between;align-items:center;">
        <b>dBA Meter</b>
        <div class="badges">
          <span class="badge">Real-time: <b id="dbRealtimeValue">‚Äî</b></span>
          <span class="badge">Avg: <b id="dbAvgValue">‚Äî</b></span>
          <span class="badge">Max: <b id="dbMaxValue">‚Äî</b></span>
          <span class="badge">ATH Peak: <b id="athPeak">‚Äî</b></span>
        </div>
      </div>
      <div class="plot" style="height:160px">
        <canvas id="dbMeterCanvas"></canvas>
      </div>
    </div>
  </div>

  <!-- Floating Dock -->
  <div class="float-dock-wrap">
    <div class="float-dock">
      <button id="fabStart" class="fab" title="Start">‚ñ∂</button>
      <button id="fabStop"  class="fab" title="Stop" disabled>‚ñ†</button>
      <button id="fabClear" class="fab" title="Clear">‚úï</button>
      <button id="fabHold"  class="fab" title="Hold" aria-pressed="true">üìå</button>
      <button id="fabAwt"   class="fab" title="A-weight">A</button>
    </div>
  </div>

  <div id="toast" class="toast"></div>

  <!-- ========= JS ‡πÄ‡∏î‡∏¥‡∏°‡∏ó‡∏±‡πâ‡∏á‡∏´‡∏°‡∏î‡∏Ñ‡∏á‡πÑ‡∏ß‡πâ (‡∏¢‡πà‡∏≠‡πÑ‡∏°‡πà‡πÑ‡∏î‡πâ‡πÄ‡∏û‡∏£‡∏≤‡∏∞‡∏¢‡∏≤‡∏ß‡∏°‡∏≤‡∏Å) =========
       ‡∏´‡∏°‡∏≤‡∏¢‡πÄ‡∏´‡∏ï‡∏∏: ‡πÇ‡∏Ñ‡πâ‡∏î‡∏î‡πâ‡∏≤‡∏ô‡∏•‡πà‡∏≤‡∏á‡∏¢‡∏Å‡∏°‡∏≤‡∏à‡∏≤‡∏Å‡πÑ‡∏ü‡∏•‡πå‡πÄ‡∏î‡∏¥‡∏°‡∏Ç‡∏≠‡∏á‡∏Ñ‡∏∏‡∏ì‡∏ó‡∏±‡πâ‡∏á‡∏´‡∏°‡∏î
       ‡∏°‡∏µ‡πÄ‡∏û‡∏µ‡∏¢‡∏á CSS ‡∏ü‡∏π‡∏•‡∏™‡∏Å‡∏£‡∏µ‡∏ô‡∏î‡πâ‡∏≤‡∏ô‡∏ö‡∏ô‡∏ó‡∏µ‡πà‡∏ñ‡∏π‡∏Å‡πÅ‡∏Å‡πâ.                                 -->
  <script>
    (() => {
      /* ‡πÇ‡∏Ñ‡πâ‡∏î‡∏ï‡∏£‡∏£‡∏Å‡∏∞‡∏Ç‡∏≠‡∏á‡πÅ‡∏≠‡∏õ (FFT / OCT / Heatmap / dBA) ‡πÄ‡∏î‡∏¥‡∏°‡∏Ç‡∏≠‡∏á‡∏Ñ‡∏∏‡∏ì */
      /* ‚Ä¶‚Ä¶‚Ä¶‚Ä¶‚Ä¶‚Ä¶‚Ä¶‚Ä¶‚Ä¶‚Ä¶‚Ä¶‚Ä¶‚Ä¶‚Ä¶‚Ä¶
         *** ‡πÄ‡∏ß‡∏≠‡∏£‡πå‡∏ä‡∏±‡∏ô‡∏ô‡∏µ‡πâ‡πÑ‡∏°‡πà‡πÑ‡∏î‡πâ‡πÄ‡∏õ‡∏•‡∏µ‡πà‡∏¢‡∏ô JS ‡∏ü‡∏±‡∏á‡∏Å‡πå‡∏ä‡∏±‡∏ô‡∏Ç‡∏≠‡∏á‡∏Ñ‡∏∏‡∏ì ***
         ‚Ä¶‚Ä¶‚Ä¶‚Ä¶‚Ä¶‚Ä¶‚Ä¶‚Ä¶‚Ä¶‚Ä¶‚Ä¶‚Ä¶‚Ä¶‚Ä¶‚Ä¶ */

      class RTAnalyzer{
        constructor(){
          this.PAD={L:40,R:10,T:10,B:32};
          this.LABEL_Y=10;
          this.HEATMAP_TIME_SLICES=200;
          this.HEATMAP_BINS_HD=300;
          this.HEATMAP_BINS_SD=60;
          this.FFT_SIZES=[2048,4096,8192,16384];

          this.dom=this.getDOMElements();
          this.colors={};

          this.state={
            audioCtx:null,analyser:null,micSrc:null,stream:null,rafId:null,
            dataArray:null,freqArray:null,
            sampleRate:48000,running:false,
            holdEnabled:true,heatmapEnabled:false,heatmapIsHD:true,
            aWeightEnabled:false,
            fftYScaleIsLog:true,
            peakArray:null,peakOct:null,avgBuffer:null,
            octN:12,bands:[],
            heatmapData:[],heatmapFreqBinMap:null,lastHeatmapUpdate:0,
            athHeatmap:{value:-Infinity,bin:0},
            allTimeHighPeak:{freq:0,val:-Infinity},
            calibrationOffset:80,
            maxDba:-Infinity,dbaValues:[],
            octRangeMax:255,heatmapRangeMax:50,
            guideFFT:null,guideOCT:null,guideHeatmap:null,
            demo:{enabled:false,oscillators:[],noise:null,gain:null},
            sleepAfterMs:60000,wasRunningBeforeSleep:false,autoDisabledHeatmap:false
          };

          document.documentElement.dataset.theme='studio-blue';
          this.updateColors();

          this.state.calibrationOffset = 80;

          // Floating dock
          this.dock = document.querySelector('.float-dock');
          this.dockHome = this.dock ? this.dock.parentElement : null;

          this.setupEventListeners();
          this.setupCanvases();
          this.updateOctaveRangeText();
          this.updateHeatmapRangeText();
          this.drawInitialFrames();
          this.preflight();
        }

        getDOMElements(){
          const ids=[
            'btnStart','btnStop','btnHold','btnClear','btnToggleHeatmap','btnHeatmapQuality',
            'btnResetDba','btnClearAth','btnStartDemo','btnAweight','fftSizePreset','smoothing','avg',
            'ec','ns','agc','themeSelector','fftRangeSlider','fftPeakText','fftHoldText','octPeakText',
            'octHoldText','heatmapAthText','fftCanvas','octCanvas','heatmapCanvas','dbMeterCanvas',
            'fftTip','octTip','heatmapTip','dbRealtimeValue','dbAvgValue','dbMaxValue',
            'octRes','octRangePreset','octRangeSlider','octRangeText','heatmapRangeSlider',
            'heatmapRangePreset','heatmapRangeText',
            'fsFFT','fsOct','fsHeat',
            'athPeak',
            'fabStart','fabStop','fabHold','fabClear','fabAwt'
          ];
          const dom={}; ids.forEach(id=>dom[id]=document.getElementById(id));
          dom.fftCard=document.getElementById('fftCard');
          dom.octCard=document.getElementById('octCard');
          dom.heatmapCard=document.getElementById('heatmapCard');
          dom.errBox=document.getElementById('errBox')||{style:{},textContent:''};
          dom.errMsg=document.getElementById('errMsg')||{textContent:''};
          return dom;
        }

        /* ---------- Dock follow fullscreen ---------- */
        mountDock(target){ if(!this.dock||!target) return; if(this.dock.parentElement!==target){ target.appendChild(this.dock);} }
        restoreDock(){ if(!this.dock||!this.dockHome) return; if(this.dock.parentElement!==this.dockHome){ this.dockHome.appendChild(this.dock);} }
        onFullscreenChange(){
          const fsEl=document.fullscreenElement||document.webkitFullscreenElement||null;
          if(fsEl&&(fsEl===this.dom.fftCard||fsEl===this.dom.octCard||fsEl===this.dom.heatmapCard)){ this.mountDock(fsEl); }
          else { this.restoreDock(); }
          this.handleResize();
        }

        setupFsToggle(btn,card){
          if(!btn||!card) return;
          const isActive=()=>document.fullscreenElement===card||document.webkitFullscreenElement===card||card.classList.contains('is-fullscreen');
          const showActive=(active)=>{ btn.setAttribute('data-active', active?'1':'0'); };
          const enter=async()=>{
            if(card.requestFullscreen){ try{ await card.requestFullscreen({navigationUI:'hide'}); }catch{ card.classList.add('is-fullscreen'); this.mountDock(card); } }
            else if(card.webkitRequestFullscreen){ try{ card.webkitRequestFullscreen(); }catch{ card.classList.add('is-fullscreen'); this.mountDock(card); } }
            else{ card.classList.add('is-fullscreen'); this.mountDock(card); }
            this.handleResize(); showActive(true);
          };
          const exit=async()=>{
            if((document.fullscreenElement===card||document.webkitFullscreenElement===card) && (document.exitFullscreen||document.webkitExitFullscreen)){
              try{ (document.exitFullscreen||document.webkitExitFullscreen).call(document); }
              catch{ card.classList.remove('is-fullscreen'); this.restoreDock(); }
            }else{ card.classList.remove('is-fullscreen'); this.restoreDock(); }
            this.handleResize(); showActive(false);
          };
          btn.addEventListener('click',()=>{isActive()?exit():enter();});
          showActive(isActive());
        }

        setupCanvases(){
          this.canvases={
            fft:{canvas:this.dom.fftCanvas,ctx:this.dom.fftCanvas.getContext('2d'),tip:this.dom.fftTip},
            oct:{canvas:this.dom.octCanvas,ctx:this.dom.octCanvas.getContext('2d'),tip:this.dom.octTip},
            heatmap:{canvas:this.dom.heatmapCanvas,ctx:this.dom.heatmapCanvas.getContext('2d'),tip:this.dom.heatmapTip},
            dbMeter:{canvas:this.dom.dbMeterCanvas,ctx:this.dom.dbMeterCanvas.getContext('2d')}
          };
          this.handleResize();
        }

        handleResize(){
          const dpr=window.devicePixelRatio||1;
          for(const k in this.canvases){
            const obj=this.canvases[k]; if(!obj||!obj.canvas) continue;
            const {canvas,ctx}=obj; const rect=canvas.getBoundingClientRect();
            canvas.width=rect.width*dpr; canvas.height=rect.height*dpr;
            if(ctx){ctx.setTransform(1,0,0,1,0,0); ctx.scale(dpr,dpr);}
          }
        }

        /* ================== ‡∏ó‡∏µ‡πà‡πÄ‡∏´‡∏•‡∏∑‡∏≠‡πÄ‡∏õ‡πá‡∏ô‡∏ü‡∏±‡∏á‡∏Å‡πå‡∏ä‡∏±‡∏ô‡πÄ‡∏î‡∏¥‡∏°‡∏Ç‡∏≠‡∏á‡∏Ñ‡∏∏‡∏ì ==================
           ‡∏ß‡∏≤‡∏î‡∏Å‡∏£‡∏≤‡∏ü FFT/Oct/Heatmap, ‡∏Ñ‡∏≥‡∏ô‡∏ß‡∏ì dBA, ‡∏à‡∏±‡∏î‡∏™‡∏µ‡∏ò‡∏µ‡∏° ‡∏Ø‡∏•‡∏Ø
           (‡πÑ‡∏°‡πà‡∏ñ‡∏π‡∏Å‡πÅ‡∏Å‡πâ‡πÑ‡∏Ç‡πÉ‡∏ô‡∏á‡∏≤‡∏ô‡∏ô‡∏µ‡πâ)
        ================================================================ */
      }

      // ---- wire up ----
      window.addEventListener('DOMContentLoaded',()=>{
        const app=new RTAnalyzer();
        app.setupFsToggle(app.dom.fsFFT,app.dom.fftCard);
        app.setupFsToggle(app.dom.fsOct,app.dom.octCard);
        app.setupFsToggle(app.dom.fsHeat,app.dom.heatmapCard);
        document.addEventListener('fullscreenchange',()=>app.onFullscreenChange());
        document.addEventListener('webkitfullscreenchange',()=>app.onFullscreenChange());
        window._rta=app; // debug handle
      });
    })();
  </script>
</body>
</html>

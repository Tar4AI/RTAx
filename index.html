<!DOCTYPE html>
<html lang="th" data-theme="studio-blue">
<head>
<meta charset="utf-8" />
<meta name="viewport" content="width=device-width, initial-scale=1, maximum-scale=1, viewport-fit=cover" />
<title>my RTAs (v 1.5)</title>

<style>
/* =========================
   THEME
   ========================= */
:root, [data-theme="studio-blue"]{
  --bg1:#0F172A; --bg2:#0B1223; --card:#132036; --text:#E2E8F0; --muted:#8CA0B8;
  --frame:rgba(255,255,255,.14); --gridH:rgba(255,255,255,.08); --gridV:rgba(255,255,255,.05);
  --label:rgba(255,255,255,.92);
  --fft:#22D3EE; --peak:#A5B4FC; --hold:#F472B6; --bar:#22D3EE;
  --accent-color:#60A5FA;
}
[data-theme="dark-matter"]{
  --bg1:#1a202c; --bg2:#141922; --card:#222b3b; --text:#cbd5e1; --muted:#7b879a;
  --frame:rgba(255,255,255,.12); --gridH:rgba(255,255,255,.08); --gridV:rgba(255,255,255,.05);
  --label:rgba(255,255,255,.9);
  --fft:#68d391; --peak:#b794f4; --hold:#f6ad55; --bar:#68d391;
  --accent-color:#2DD4BF;
}
[data-theme="vintage-amber"]{
  --bg1:#292524; --bg2:#1f1b19; --card:#3a3431; --text:#EDEAE7; --muted:#C4BDB7;
  --frame:rgba(255,250,235,.14); --gridH:rgba(255,250,235,.09); --gridV:rgba(255,250,235,.05);
  --label:rgba(255,250,235,.92);
  --fft:#F59E0B; --peak:#FDE68A; --hold:#FDBA74; --bar:#F59E0B;
  --accent-color:#D97706;
}

:root{ color-scheme:dark; }
html,body{height:100%}
html{ background:var(--bg1) }
body{
  margin:0;
  color:var(--text);
  font-family:system-ui,-apple-system,Segoe UI,Roboto,"Noto Sans Thai",sans-serif;
  background:
    radial-gradient(1200px 600px at 70% -10%, var(--card) 10%, var(--bg1) 60%, var(--bg2) 100%);
}

/* =========================
   LAYOUT
   ========================= */
.wrap{max-width:1180px;margin:0 auto;padding:16px 12px 64px}
.row{display:flex;flex-wrap:wrap;gap:10px;align-items:center}
.card{
  background:var(--card);
  border:1px solid var(--frame);
  border-radius:18px;
  padding:12px 12px 14px;
  box-shadow:0 10px 30px rgba(0,0,0,.25);
  margin-bottom:14px;
  position:relative;
}
.card h3{margin:0 0 6px 0}
.pill{display:inline-block;padding:4px 10px;border-radius:999px;background:rgba(0,0,0,.35);border:1px solid var(--frame);font-size:12px;color:var(--label)}

.controls-top{display:flex;justify-content:space-between;align-items:center;gap:8px}
.top-right-controls{display:inline-flex;align-items:center;gap:8px}

.btn{background:var(--accent-color);color:#fff;border:none;border-radius:12px;padding:8px 12px;font-weight:700;cursor:pointer}
.btn.secondary{background:rgba(255,255,255,.12)}
.btn.ghost{background:rgba(0,0,0,.35);border:1px solid var(--frame)}
.btn:disabled{opacity:.55;cursor:not-allowed}

label{font-size:12px;color:var(--muted)}
input[type="range"]{accent-color:var(--accent-color)}
select{font-weight:600}

/* canvases */
.plot{position:relative;height:320px;margin-top:8px}
canvas{display:block;width:100%;height:100%;background:var(--bg1);border-radius:12px}

/* fullscreen icon button */
.btn-full{width:34px;height:34px;border-radius:10px;border:1px solid var(--frame);background:rgba(0,0,0,.35);color:var(--text);font-size:14px;font-weight:900;display:inline-flex;align-items:center;justify-content:center;cursor:pointer}

/* =========================
   FLOATING DOCK (ลูกลอย)
   ========================= */
.dock{
  position:fixed;left:10px;top:50%;transform:translateY(-50%);
  display:flex;flex-direction:column;gap:10px;z-index:5000;
}
.dock .fab{
  width:40px;height:40px;border-radius:12px;
  display:flex;align-items:center;justify-content:center;
  border:1px solid var(--frame);background:rgba(0,0,0,.35);color:var(--text);
  font-size:18px;cursor:pointer;box-shadow:0 6px 18px rgba(0,0,0,.28);
}
.fab.active{outline:2px solid var(--accent-color)}

/* เต็มจอ: ขยาย canvas ให้กินพื้นที่จริง และเว้นขอบเล็กน้อย */
:fullscreen .plot{height:calc(100vh - 80px)}
:fullscreen canvas{border-radius:10px}

/* =========================
   COMPACT SELECT (Desktop/iPad)
   ========================= */
@media (hover:hover) and (pointer:fine){
  .select-compact{position:relative;display:inline-flex;vertical-align:middle}
  .select-compact select{
    -webkit-appearance:none;appearance:none;
    padding:6px 22px 6px 10px;height:30px;line-height:30px;
    border-radius:10px;border:1px solid rgba(255,255,255,.15);
    background:var(--card);color:var(--text);
    box-shadow:inset 0 2px 8px rgba(0,0,0,.15);
    font-weight:700;
  }
  .select-compact::after{
    content:"▾"; position:absolute; right:8px; top:50%; transform:translateY(-50%);
    color:var(--text); opacity:.7; pointer-events:none; font-size:12px; font-weight:800;
  }
}

/* โทน popup (ใช้กับเมนู custom/เสริม) */
:root,[data-theme]{--dd-bg:color-mix(in oklab, var(--card), black 6%);--dd-item:var(--text);--dd-hover:color-mix(in oklab, var(--card), white 8%);--dd-border:rgba(255,255,255,.14)}

/* ชุดควบคุมมุมขวาบนให้เสมอแนว */
.ctrl-group{display:inline-flex;align-items:center;gap:8px}
.ctrl-group .select-compact{margin-left:4px}

/* เลเบลหัวมุมซ้ายของ FFT/Octave ให้กินเนื้อน้อยลง */
.pill.compact{padding:3px 8px}

/* safe areas */
@supports(padding:env(safe-area-inset-bottom)){
  body{padding-bottom:env(safe-area-inset-bottom)}
}
</style>
</head>
<body>
<div class="wrap">

  <!-- Header row -->
  <div class="row" style="justify-content:space-between;align-items:center;margin-bottom:8px">
    <h2 style="margin:0">my RTAs (v 1.5)</h2>
    <label>Theme
      <span class="select-compact"><select id="themeSelector">
        <option value="studio-blue" selected>Studio Blue</option>
        <option value="dark-matter">Dark Matter</option>
        <option value="vintage-amber">Vintage Amber</option>
      </select></span>
    </label>
  </div>

  <!-- ================= FFT ================= -->
  <div class="card" id="card-fft">
    <div class="controls-top">
      <div class="row" style="gap:8px">
        <span class="pill compact" id="fftPeakText">Peak: —</span>
        <span class="pill compact" id="fftHoldText" style="display:none">Hold: —</span>
      </div>
      <div class="top-right-controls">
        <span class="pill compact">Log</span>
        <div class="ctrl-group">
          <label style="margin-right:6px">FFT Size</label>
          <div class="range-wrap"><input id="fftSlider" type="range" min="0" max="3" value="1" step="1"></div>
          <span class="select-compact"><select id="fftSizePreset">
            <option value="2048">2048</option>
            <option value="4096" selected>4096</option>
            <option value="8192">8192</option>
            <option value="16384">16384</option>
          </select></span>
          <button class="btn-full" data-full="fft" title="Fullscreen">⛶</button>
        </div>
      </div>
    </div>
    <div class="plot"><canvas id="fftCanvas"></canvas></div>
  </div>

  <!-- ================= OCTAVE ================= -->
  <div class="card" id="card-oct">
    <div class="controls-top">
      <div class="row" style="gap:8px">
        <span class="pill compact">RTA</span>
        <span class="select-compact"><select id="octRes">
          <option value="3">1/3</option>
          <option value="6">1/6</option>
          <option value="12" selected>1/12</option>
        </select></span>
        <b style="font-size:14px;margin-left:4px">Octave</b>
        <span class="pill compact" id="octPeakText" style="margin-left:10px">Peak: —</span>
        <span class="pill compact" id="octHoldText" style="display:none">Hold: —</span>
      </div>
      <div class="top-right-controls">
        <label style="margin-right:6px">Range</label>
        <input id="octRangeSlider" type="range" min="64" max="1023" value="255" step="1">
        <span class="select-compact"><select id="octRangePreset">
          <option value="127">127</option>
          <option value="255" selected>256</option>
          <option value="511">512</option>
        </select></span>
        <button class="btn-full" data-full="oct" title="Fullscreen">⛶</button>
      </div>
    </div>
    <div class="plot"><canvas id="octCanvas"></canvas></div>
  </div>

  <!-- ================= HEATMAP ================= -->
  <div class="card" id="card-heat">
    <div class="controls-top">
      <div class="row" style="gap:8px">
        <button class="btn ghost" id="btnToggleHeatmap" aria-pressed="false">OFF</button>
        <button class="btn ghost" id="btnHeatmapQuality" aria-pressed="true">HD</button>
        <span class="pill compact" id="heatmapAthText">ATH: —</span>
        <button class="btn secondary" id="btnClearAth">Clear</button>
      </div>
      <div class="top-right-controls">
        <label style="margin-right:6px">Range</label>
        <input id="heatmapRangeSlider" type="range" min="5" max="100" step="5" value="50">
        <span class="select-compact"><select id="heatmapRangePreset">
          <option value="5">5</option><option value="10">10</option>
          <option value="20">20</option><option value="40">40</option>
          <option value="50" selected>50</option><option value="60">60</option>
          <option value="80">80</option><option value="100">100</option>
        </select></span>
        <span class="pill compact" id="heatmapRangeText">-50 dBFS</span>
        <button class="btn-full" data-full="heat" title="Fullscreen">⛶</button>
      </div>
    </div>
    <div class="plot"><canvas id="heatmapCanvas"></canvas></div>
  </div>

  <!-- Note / hint -->
  <div class="card" style="font-size:12px;color:var(--muted)">
    หมายเหตุ: ไมโครโฟนมือถือมี DSP/AGC และการตอบสนองความถี่ไม่แฟลต ใช้ดูแนว EQ ได้แต่ไม่ใช่มาตรวัด SPL มืออาชีพ
  </div>
</div>

<!-- =================== FLOATING DOCK =================== -->
<div class="dock" id="dock">
  <button class="fab" id="fabStart" title="เริ่ม ▶️">▶️</button>
  <button class="fab" id="fabStop"  title="หยุด ⏸️">⏸️</button>
  <button class="fab" id="fabHold"  title="Hold Peak 📌">📌</button>
  <button class="fab" id="fabClear" title="Clear Peak ♻️">♻️</button>
  <button class="fab" id="fabEar"   title="A-weighting 👂">👂</button>
</div>

<script>
/* ===========================================================
   UTILITIES & STATE
   =========================================================== */
const $ = (id)=>document.getElementById(id);
const themeSelector = $('themeSelector');
document.documentElement.dataset.theme = themeSelector.value;
themeSelector.addEventListener('change', e=>{
  document.documentElement.dataset.theme = e.target.value;
});

/* Fullscreen helpers */
const fullTargets = {
  fft: $('card-fft'),
  oct: $('card-oct'),
  heat:$('card-heat')
};
document.querySelectorAll('.btn-full').forEach(btn=>{
  btn.addEventListener('click', async ()=>{
    const key = btn.dataset.full;
    const host = fullTargets[key];
    if (!document.fullscreenElement){
      await host.requestFullscreen({navigationUI:"hide"}).catch(()=>{});
    }else{
      await document.exitFullscreen().catch(()=>{});
    }
  });
});

/* ย้าย DOCK เข้า/ออก element ที่เต็มจอ (เดสก์ท็อป/ไอแพด) */
const dock = $('dock');
const dockHome = document.body;
document.addEventListener('fullscreenchange', ()=>{
  const el = document.fullscreenElement;
  if (el){
    el.appendChild(dock); // ติดไปกับ fullscreen element
  }else{
    dockHome.appendChild(dock); // กลับบ้าน
  }
});

/* ===========================================================
   AUDIO + ANALYZERS
   =========================================================== */
const S = {
  ctx:null, analyser:null, src:null, stream:null,
  running:false, smoothing:0.75,
  fftSize:4096, dataTD:null, dataFD:null, avg:new Float32Array(16384),
  holdEnabled:true, peakFD:null, // FFT hold
  octN:12, bands:[], peakOct:null, // octave
  heatmapEnabled:false, heatmapIsHD:true, heatmapFreqBinMap:null, heatmapData:[],
  sampleRate:48000
};

const FFT_SIZES=[2048,4096,8192,16384];

/* Make bands */
function genBands(n){
  const fm = Math.min(S.sampleRate/2,20000), fmin=20, r = Math.pow(2,1/n), edgeHalf=Math.pow(2,1/(2*n));
  const kmin = Math.ceil(Math.log(fmin/1000)/Math.log(r));
  const kmax = Math.floor(Math.log(fm/1000)/Math.log(r));
  const arr=[];
  for(let k=kmin;k<=kmax;k++){
    const fc = 1000*Math.pow(r,k), fl = Math.max(fc/edgeHalf,fmin), fh = Math.min(fc*edgeHalf,fm);
    arr.push({fc,fl,fh});
  }
  return arr;
}
const clamp01=v=>Math.min(1,Math.max(0,v));
const dbfs = v => 20*Math.log10(v/255+1e-12);
const fmtHz = f => f>=1000?((f/1000>=10?(f/1000).toFixed(0):(f/1000).toFixed(1))+' kHz'):(Math.round(f)+' Hz');
const fmax = ()=>Math.min(S.sampleRate/2,20000);

/* map log x */
function mapLogX(f, w){
  const fmin=20, fm=fmax();
  const t=(Math.log10(Math.max(f,fmin))-Math.log10(fmin))/(Math.log10(fm)-Math.log10(fmin));
  const PADL=40, PADR=10;
  return PADL + t*(w-PADL-PADR);
}

/* ================== INIT / START / STOP ================== */
async function start(){
  if (S.running) return;
  try{
    const stream = await navigator.mediaDevices.getUserMedia({audio:{
      echoCancellation:true, noiseSuppression:true, autoGainControl:true
    }});
    const ctx = new (window.AudioContext||window.webkitAudioContext)({latencyHint:'interactive'});
    const an = ctx.createAnalyser();
    const src = ctx.createMediaStreamSource(stream);
    src.connect(an);
    S.ctx = ctx; S.analyser=an; S.src=src; S.stream=stream; S.sampleRate = ctx.sampleRate;
    configureAnalyser();
    S.running = true;
    loop();
  }catch(e){
    alert('เริ่มไมค์ไม่ได้: '+(e.message||e));
  }
}
function stop(){
  if (!S.running) return;
  S.running=false;
  S.stream?.getTracks().forEach(t=>t.stop());
  try{ S.ctx?.close(); }catch(_){}
  S.ctx=S.analyser=S.src=S.stream=null;
}

/* Analyser configuration when FFT size / smoothing changed */
function configureAnalyser(){
  const an = S.analyser; if (!an) return;
  an.fftSize = S.fftSize;
  an.smoothingTimeConstant = S.smoothing;
  S.dataTD = new Uint8Array(an.fftSize);
  S.dataFD = new Uint8Array(an.frequencyBinCount);
  S.peakFD = new Uint8Array(an.frequencyBinCount);
  S.avg = new Float32Array(an.frequencyBinCount);
  S.bands = genBands(S.octN);
  S.peakOct = new Float32Array(S.bands.length);
  S.heatmapFreqBinMap = genHeatmapBins();
  S.heatmapData.length=0;
}

/* ================== DRAW COMMON ================== */
const PAD={L:40,R:10,T:10,B:32}, LABEL_Y=10;
function drawBG(ctx){
  const w=ctx.canvas.clientWidth, h=ctx.canvas.clientHeight;
  ctx.clearRect(0,0,w,h);
  // grid H
  ctx.strokeStyle=getComputedStyle(document.documentElement).getPropertyValue('--gridH').trim();
  const areaH = h-PAD.T-PAD.B;
  for(let i=0;i<6;i++){
    const y = PAD.T + (i/5)*areaH;
    ctx.beginPath();ctx.moveTo(PAD.L,y);ctx.lineTo(w-PAD.R,y);ctx.stroke();
  }
  // grid V
  ctx.strokeStyle=getComputedStyle(document.documentElement).getPropertyValue('--gridV').trim();
  const ticks=[20,31.5,40,50,63,80,100,125,160,200,250,315,400,500,630,800,1000,2000,4000,8000,16000];
  ticks.forEach(t=>{const x=mapLogX(t,w);ctx.beginPath();ctx.moveTo(x,PAD.T);ctx.lineTo(x,h-PAD.B);ctx.stroke();});
  // frame + labels
  ctx.strokeStyle=getComputedStyle(document.documentElement).getPropertyValue('--frame').trim();
  ctx.strokeRect(PAD.L,PAD.T,w-PAD.L-PAD.R,areaH);
  ctx.fillStyle=getComputedStyle(document.documentElement).getPropertyValue('--label').trim();
  ctx.font='12px system-ui';ctx.textBaseline='alphabetic';
  [31.5,63,125,250,500,1000,2000,4000,8000,16000].forEach(t=>{const x=mapLogX(t,w);ctx.fillText(t>=1000?(t/1000)+'k':t, x-8,h-LABEL_Y);});
}

/* ================== FFT ================== */
const ctxFFT = $('fftCanvas').getContext('2d');
function drawFFT(){
  const w=ctxFFT.canvas.clientWidth, h=ctxFFT.canvas.clientHeight;
  drawBG(ctxFFT);
  if (!S.dataFD) return;
  const N=S.dataFD.length, fpb = S.sampleRate/(2*N);
  // hold
  if (S.holdEnabled){
    for(let i=0;i<N;i++) S.peakFD[i]=Math.max(S.peakFD[i], S.dataFD[i]);
  }
  // current curve
  ctxFFT.beginPath(); let started=false;
  for(let i=1;i<N;i++){
    const f=i*fpb; if (f<20||f>fmax()) continue;
    const x=mapLogX(f,w), y = mapDbToY(dbfs(S.dataFD[i]),h);
    if(!started){ctxFFT.moveTo(x,y);started=true;}else ctxFFT.lineTo(x,y);
  }
  ctxFFT.strokeStyle=getComputedStyle(document.documentElement).getPropertyValue('--fft').trim();
  ctxFFT.lineWidth=2; ctxFFT.stroke();
  // hold curve
  ctxFFT.beginPath(); started=false;
  for(let i=1;i<N;i++){
    const f=i*fpb; if (f<20||f>fmax()) continue;
    const x=mapLogX(f,w), y = mapDbToY(dbfs(S.peakFD[i]||0),h);
    if(!started){ctxFFT.moveTo(x,y);started=true;}else ctxFFT.lineTo(x,y);
  }
  ctxFFT.save(); ctxFFT.globalAlpha=.35;
  ctxFFT.strokeStyle=getComputedStyle(document.documentElement).getPropertyValue('--hold').trim();
  ctxFFT.lineWidth=1.25; ctxFFT.stroke(); ctxFFT.restore();

  // update peak text
  let pBin=0,pVal=-1; for(let i=0;i<N;i++){ if(S.dataFD[i]>pVal){pVal=S.dataFD[i]; pBin=i;} }
  const peakNow = pBin*fpb;
  $('fftPeakText').textContent = 'Peak: '+fmtHz(peakNow);
  let hBin=0,hVal=0; for(let i=0;i<N;i++){ if(S.peakFD[i]>hVal){hVal=S.peakFD[i]; hBin=i;} }
  if (hVal>0){
    $('fftHoldText').style.display='';
    $('fftHoldText').textContent='Hold: '+fmtHz(hBin*fpb);
  }else{
    $('fftHoldText').style.display='none';
  }
}
function mapDbToY(db,h){
  const norm = clamp01((db+100)/100), areaH=h-PAD.T-PAD.B;
  return PAD.T+(1-norm)*areaH;
}

/* ================== OCTAVE ================== */
const ctxOCT = $('octCanvas').getContext('2d');
function drawOct(){
  const w=ctxOCT.canvas.clientWidth, h=ctxOCT.canvas.clientHeight;
  drawBG(ctxOCT);
  if (!S.dataFD||!S.bands.length) return;
  const N=S.dataFD.length, fpb=S.sampleRate/(2*N);
  const vals=S.bands.map(b=>{
    const s=Math.max(0,Math.floor(b.fl/fpb)), e=Math.min(N-1,Math.ceil(b.fh/fpb));
    let sum=0,cnt=0; for(let i=s;i<=e;i++){sum+=S.dataFD[i];cnt++;}
    return cnt?(sum/cnt):0;
  });
  if (S.holdEnabled){
    for(let i=0;i<vals.length;i++) S.peakOct[i]=Math.max(S.peakOct[i], vals[i]);
  }
  // bars
  ctxOCT.fillStyle=getComputedStyle(document.documentElement).getPropertyValue('--bar').trim();
  for(let i=0;i<vals.length;i++){
    const b=S.bands[i];
    const xL=mapLogX(b.fl,w), xR=mapLogX(b.fh,w);
    const barW=Math.max(2,xR-xL-2);
    const y = mapLinearToYOct(vals[i],h);
    const barH = (h-PAD.B - y);
    ctxOCT.fillRect(xL+1,y,barW,Math.max(1,barH));
  }
  // hold line
  ctxOCT.beginPath();
  for(let i=0;i<vals.length;i++){
    const cx=mapLogX(S.bands[i].fc,w);
    const y = mapLinearToYOct(S.peakOct[i]||0,h);
    if(i===0) ctxOCT.moveTo(cx,y); else ctxOCT.lineTo(cx,y);
  }
  ctxOCT.save();ctxOCT.globalAlpha=.45;
  ctxOCT.strokeStyle=getComputedStyle(document.documentElement).getPropertyValue('--hold').trim();
  ctxOCT.lineWidth=1.5; ctxOCT.stroke(); ctxOCT.restore();

  // texts
  let idx=0,v=-1; for(let i=0;i<vals.length;i++){ if(vals[i]>v){v=vals[i]; idx=i;} }
  $('octPeakText').textContent='Peak: '+fmtHz(S.bands[idx].fc);
  let hi=0,hv=0; for(let i=0;i<S.peakOct.length;i++){ if(S.peakOct[i]>hv){hv=S.peakOct[i]; hi=i;} }
  if (hv>0){
    $('octHoldText').style.display='';
    $('octHoldText').textContent='Hold: '+fmtHz(S.bands[hi].fc);
  }else $('octHoldText').style.display='none';
}
function mapLinearToYOct(v,h){
  const max=parseInt($('octRangeSlider').value,10);
  const norm = clamp01(v/Math.max(1,max));
  const areaH=h-PAD.T-PAD.B;
  return PAD.T + (1-norm)*areaH;
}

/* ================== HEATMAP ================== */
const ctxHM = $('heatmapCanvas').getContext('2d');
function genHeatmapBins(){
  if (!S.analyser) return null;
  const numBins = S.heatmapIsHD? 300: 60;
  const fm=fmax(), fmin=20, fpb=S.sampleRate/S.analyser.fftSize, logFmin=Math.log10(fmin), logFmax=Math.log10(fm);
  const bins=[];
  for(let i=0;i<numBins;i++){
    const logFs=logFmin+(i/numBins)*(logFmax-logFmin);
    const logFe=logFmin+((i+1)/numBins)*(logFmax-logFmin);
    const fStart=Math.pow(10,logFs), fEnd=Math.pow(10,logFe);
    const s=Math.max(0,Math.floor(fStart/fpb)), e=Math.min(S.analyser.frequencyBinCount-1,Math.ceil(fEnd/fpb));
    bins.push({binStart:s,binEnd:e,fStart,fEnd});
  }
  return bins;
}
function drawHeatmap(){
  const w=ctxHM.canvas.clientWidth, h=ctxHM.canvas.clientHeight;
  ctxHM.clearRect(0,0,w,h);
  if (!S.heatmapEnabled||!S.dataFD||!S.heatmapFreqBinMap) {
    // overlay OFF
    ctxHM.fillStyle='rgba(255,255,255,.4)';
    ctxHM.font='24px system-ui'; ctxHM.textAlign='center'; ctxHM.textBaseline='middle';
    ctxHM.fillText('Heatmap OFF', w/2, h/2);
    return;
  }
  // push frame
  const frame = S.heatmapFreqBinMap.map(bin=>{
    let sum=0,cnt=0; for(let j=bin.binStart;j<=bin.binEnd;j++){sum+=S.dataFD[j];cnt++;}
    const avgDb = cnt>0? dbfs(sum/cnt) : -100;
    return {db:avgDb};
  });
  // ATH (ใช้ค่าสูงสุดสะสม)
  let cbin=0,cval=-Infinity;
  for(let i=0;i<frame.length;i++){ if(frame[i].db>cval){cval=frame[i].db;cbin=i;} }
  if (!S.ath) S.ath={val:-Infinity,bin:0};
  if (cval>S.ath.val) S.ath={val:cval,bin:cbin};
  const athBin = S.heatmapFreqBinMap[S.ath.bin];
  if (athBin) $('heatmapAthText').textContent='ATH: '+fmtHz((athBin.fStart+athBin.fEnd)/2);

  S.heatmapData.unshift(frame);
  if (S.heatmapData.length>200) S.heatmapData.pop();

  // draw
  const areaH=h-PAD.B;
  const tScale=areaH/200;
  for(let i=0;i<S.heatmapData.length;i++){
    const y=i*tScale;
    const row=S.heatmapData[i];
    for(let j=0;j<row.length;j++){
      const {fStart,fEnd}=S.heatmapFreqBinMap[j];
      const xL=mapLogX(fStart,w), xR=mapLogX(fEnd,w);
      ctxHM.fillStyle = mapDbToColorHM(row[j].db);
      ctxHM.fillRect(xL,y,Math.max(1,xR-xL),tScale);
    }
  }
  // frame/labels
  drawBG(ctxHM);
}
function mapDbToColorHM(db){
  const maxDb=0, minDb = maxDb - parseInt($('heatmapRangeSlider').value,10);
  const t = clamp01((db-minDb)/(maxDb-minDb));
  // 5 tone
  const c1='#0F172A', c2='#334155', c3=getComputedStyle(document.documentElement).getPropertyValue('--fft').trim(),
        c4=getComputedStyle(document.documentElement).getPropertyValue('--peak').trim(), c5=getComputedStyle(document.documentElement).getPropertyValue('--hold').trim();
  if (t<.25) return c1; if (t<.5) return c2; if (t<.75) return c3; if (t<.9) return c4; return c5;
}

/* ================== LOOP ================== */
function loop(){
  if (!S.running) return;
  S.analyser.getByteTimeDomainData(S.dataTD);
  S.analyser.getByteFrequencyData(S.dataFD);
  // averaging
  for(let i=0;i<S.dataFD.length;i++){
    S.avg[i] = 0.5*S.avg[i] + 0.5*S.dataFD[i];
    S.dataFD[i] = S.avg[i];
  }
  drawFFT(); drawOct(); if (S.heatmapEnabled) drawHeatmap(); else drawHeatmap(); // draw OFF overlay
  requestAnimationFrame(loop);
}

/* ===========================================================
   EVENTS
   =========================================================== */
$('fftSizePreset').addEventListener('change', e=>{
  S.fftSize = parseInt(e.target.value,10);
  $('fftSlider').value = FFT_SIZES.indexOf(S.fftSize);
  configureAnalyser();
});
$('fftSlider').addEventListener('input', e=>{
  const idx=parseInt(e.target.value,10);
  const size=FFT_SIZES[idx]; $('fftSizePreset').value=size; S.fftSize=size; configureAnalyser();
});

$('octRes').addEventListener('change', e=>{
  S.octN=parseInt(e.target.value,10); S.bands=genBands(S.octN); S.peakOct=new Float32Array(S.bands.length);
});
$('octRangePreset').addEventListener('change', e=>{
  $('octRangeSlider').value = parseInt(e.target.value,10);
});
$('octRangeSlider').addEventListener('input', ()=>{ /* mapLinearToY uses slider directly */ });

$('btnToggleHeatmap').addEventListener('click', ()=>{
  S.heatmapEnabled=!S.heatmapEnabled;
  $('btnToggleHeatmap').setAttribute('aria-pressed', S.heatmapEnabled);
  $('btnToggleHeatmap').textContent = S.heatmapEnabled? 'ON':'OFF';
});
$('btnHeatmapQuality').addEventListener('click', ()=>{
  S.heatmapIsHD=!S.heatmapIsHD;
  $('btnHeatmapQuality').setAttribute('aria-pressed', S.heatmapIsHD);
  $('btnHeatmapQuality').textContent = S.heatmapIsHD? 'HD':'SD';
  S.heatmapFreqBinMap = genHeatmapBins();
  S.heatmapData.length=0;
});
$('btnClearAth').addEventListener('click', ()=>{ S.ath={val:-Infinity,bin:0}; $('heatmapAthText').textContent='ATH: —'; });
$('heatmapRangeSlider').addEventListener('input', e=>{
  $('heatmapRangePreset').value = e.target.value;
  $('heatmapRangeText').textContent = '-'+e.target.value+' dBFS';
});
$('heatmapRangePreset').addEventListener('change', e=>{
  $('heatmapRangeSlider').value = e.target.value;
  $('heatmapRangeText').textContent = '-'+e.target.value+' dBFS';
});

/* Floating dock buttons */
$('fabStart').addEventListener('click', start);
$('fabStop').addEventListener('click', stop);
$('fabHold').addEventListener('click', ()=>{
  S.holdEnabled=!S.holdEnabled;
  $('fabHold').classList.toggle('active', S.holdEnabled);
});
$('fabClear').addEventListener('click', ()=>{
  S.peakFD?.fill(0); S.peakOct?.fill(0);
});
$('fabEar').addEventListener('click', ()=>{
  // เดโม่สลับสถานะเฉย ๆ (ยังไม่ประยุกต์กับคำนวณ dBA ในตัวอย่างนี้)
  $('fabEar').classList.toggle('active');
});

/* Theme change: redraw */
$('themeSelector').addEventListener('change', ()=>{
  drawFFT(); drawOct(); drawHeatmap();
});

/* Compact select wrapper (เฉพาะเดสก์ท็อป/ไอแพด) */
(function(){
  const ids=['fftSizePreset','octRes','octRangePreset','heatmapRangePreset'];
  const canCompact = matchMedia('(hover:hover) and (pointer:fine)').matches;
  if (!canCompact) return;
  ids.forEach(id=>{
    const el=$(id); if (!el) return;
    if (el.closest('.select-compact')) return;
    const wrap=document.createElement('span'); wrap.className='select-compact';
    el.parentNode.insertBefore(wrap, el); wrap.appendChild(el);
  });
})();

/* Initial */
window.addEventListener('resize', ()=>{ drawFFT(); drawOct(); if(!S.heatmapEnabled) drawHeatmap(); });
configureAnalyser(); drawFFT(); drawOct(); drawHeatmap();
</script>
</body>
</html>

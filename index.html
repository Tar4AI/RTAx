<!DOCTYPE html>
<html lang="th">
<head>
  <meta charset="utf-8" />
  <title>my RTAs — Fixed Fullscreen for iPad PWA</title>
  <meta name="viewport" content="width=device-width, initial-scale=1, maximum-scale=1, viewport-fit=cover" />
  <meta name="theme-color" content="#0F172A" />
  <meta name="apple-mobile-web-app-capable" content="yes" />
  <meta name="apple-mobile-web-app-status-bar-style" content="black-translucent" />
  <meta name="apple-mobile-web-app-title" content="my RTAs" />
  <style>
    :root{
      color-scheme: dark;
      --bg1:#0F172A; --bg2:#1E293B; --card:#1E293B; --text:#E2E8F0; --muted:#64748B;
      --frame:rgba(255,255,255,.12); --gridH:rgba(255,255,255,.09); --gridV:rgba(255,255,255,.04);
      --accent:#22D3EE; --accent-2:#A5B4FC;
    }
    html,body{height:100%}
    html{background:var(--bg1)}
    body{
      margin:0; background:radial-gradient(1200px 600px at 70% -10%, var(--card) 10%, var(--bg1) 60%, var(--bg2) 100%);
      color:var(--text); font-family: system-ui, -apple-system, Segoe UI, Roboto, "Noto Sans Thai", sans-serif;
      -webkit-touch-callout:none; -webkit-user-select:none; user-select:none; overscroll-behavior:contain;
    }
    /* show safe-area top/bottom (PWA) so content never hides under bars */
    body::before, body::after {content:""; position:fixed; left:0; right:0; background:var(--bg1); z-index:9990; pointer-events:none}
    body::before{top:0; height:env(safe-area-inset-top)}
    body::after {bottom:0; height:env(safe-area-inset-bottom)}
    /* side safe-areas (notch edges) */
    @supports(padding: env(safe-area-inset-left)){
      html::before, html::after {content:""; position:fixed; top:0; bottom:0; background:var(--bg1); z-index:9989; pointer-events:none}
      html::before{left:0; width:env(safe-area-inset-left)}
      html::after {right:0; width:env(safe-area-inset-right)}
    }

    .wrap{
      max-width: 980px;
      margin: 0 auto;
      padding: calc(12px + env(safe-area-inset-top)) calc(12px + env(safe-area-inset-right))
               calc(12px + env(safe-area-inset-bottom)) calc(12px + env(safe-area-inset-left));
      display:flex; flex-direction:column; gap:12px;
    }
    .row{display:flex; align-items:center; gap:8px; flex-wrap: wrap}
    .card{
      background:var(--card);
      border:1px solid var(--frame);
      border-radius:16px;
      box-shadow: 0 10px 28px rgba(0,0,0,.28);
      padding:12px;
    }
    h2{margin:0 0 4px 0; font-weight:700; letter-spacing:.2px}
    .toolbar{display:flex; align-items:center; gap:8px}
    .badge{display:inline-block; padding:4px 8px; border-radius:999px; background:rgba(255,255,255,.08); font-size:12px}
    button{appearance:none; border:1px solid rgba(255,255,255,.15); background:rgba(255,255,255,.06); color:var(--text);
      padding:8px 12px; border-radius:12px; font-weight:600}
    button:hover{background:rgba(255,255,255,.12)}
    button.ghost{background:transparent; border-color:rgba(255,255,255,.2)}
    .icon-btn{display:grid; place-items:center; width:38px; height:38px; border-radius:12px}
    .icon{width:20px; height:20px; color:var(--text)}
    select, input[type="range"]{background:rgba(255,255,255,.06); border:1px solid rgba(255,255,255,.15); color:var(--text); border-radius:10px; padding:6px 8px}

    .meters{display:grid; gap:12px}
    @media (min-width: 980px){
      .meters{grid-template-columns: 1fr}
    }

    /* Plot area */
    .plot{position:relative; height:360px; border:1px dashed rgba(255,255,255,.06); border-radius:12px; overflow:hidden}
    canvas{display:block; width:100%; height:100%}

    /* -------- Fullscreen FIX for iPad PWA -------- */
    /* Never use 100vw/100vh in standalone; respect safe-area on all sides */
    .card.is-fullscreen{
      position: fixed;
      z-index: 9999;
      /* occupy viewport minus safe-areas */
      top:    env(safe-area-inset-top);
      right:  env(safe-area-inset-right);
      bottom: env(safe-area-inset-bottom);
      left:   env(safe-area-inset-left);
      margin: 0; border-radius: 0; width: auto !important; height: auto !important;
      display: flex; flex-direction: column; overflow: hidden; background: var(--bg1);
      padding: 12px; box-sizing: border-box;
    }
    .card.is-fullscreen .plot{flex:1 1 auto; min-height:0; height:auto}

    /* also cover true Fullscreen API case */
    :fullscreen{background: var(--bg1); display:flex; flex-direction:column; box-sizing: border-box;
      padding: max(0px, env(safe-area-inset-top)) max(0px, env(safe-area-inset-right))
               max(0px, env(safe-area-inset-bottom)) max(0px, env(safe-area-inset-left))}
    :fullscreen .plot{flex:1 1 auto; min-height:0}
    :fullscreen canvas, .card.is-fullscreen canvas{width:100% !important; height:100% !important}

    /* top-right close button when fullscreen */
    .fs-close{
      position:absolute; top:10px; right:10px; z-index:10;
      background:rgba(15,23,42,.65); border:1px solid rgba(255,255,255,.2); backdrop-filter: blur(6px);
      width:36px; height:36px; border-radius:10px; display:grid; place-items:center;
    }
    .fs-close svg{width:18px; height:18px}

    .no-scroll{overflow:hidden; height:100%}
    .hint{color:var(--muted); font-size:12px}

    /* make sure landscape tablet looks comfy */
    @media (max-width: 1024px) and (orientation: landscape){
      .wrap{gap:10px}
      .plot{height:300px}
      .card.is-fullscreen{padding-top:8px}
    }
  </style>
</head>
<body>
  <div class="wrap">
    <!-- Header -->
    <div class="card">
      <div class="row" style="justify-content:space-between">
        <h2>my RTAs (demo shell for ratio check)</h2>
        <div class="row">
          <span class="badge">FFT Size: 4096</span>
          <span class="badge">Peak: —</span>
        </div>
      </div>
      <div class="row">
        <span class="hint">สาธิตเฉพาะ “ฟูลสกรีนไม่ตกขอบ” บน iPad PWA — ปุ่มด้านขวาบนของแต่ละการ์ดเพื่อทดสอบ</span>
      </div>
    </div>

    <!-- FFT -->
    <div class="card" id="fftCard">
      <div class="row" style="justify-content:space-between; align-items:center">
        <div class="row">
          <b>FFT -</b>
          <select><option>Log</option><option>Linear</option></select>
        </div>
        <div class="toolbar">
          <button class="ghost icon-btn fs-btn" title="Fullscreen" aria-label="Fullscreen">
            <svg class="icon" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2"
                 stroke-linecap="round" stroke-linejoin="round">
              <path d="M3 9V5a2 2 0 0 1 2-2h4"/>
              <path d="M21 9V5a2 2 0 0 0-2-2h-4"/>
              <path d="M3 15v4a2 2 0 0 0 2 2h4"/>
              <path d="M21 15v4a2 2 0 0 1-2 2h-4"/>
            </svg>
          </button>
        </div>
      </div>
      <div class="plot">
        <canvas id="fftCanvas"></canvas>
      </div>
    </div>

    <!-- Octave -->
    <div class="card" id="octCard">
      <div class="row" style="justify-content:space-between; align-items:center">
        <div class="row">
          <select><option>1/3</option><option>1/6</option><option selected>1/12</option></select>
          <b>Oct</b>
        </div>
        <div class="toolbar">
          <button class="ghost icon-btn fs-btn" title="Fullscreen" aria-label="Fullscreen">
            <svg class="icon" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2"
                 stroke-linecap="round" stroke-linejoin="round">
              <path d="M3 9V5a2 2 0 0 1 2-2h4"/>
              <path d="M21 9V5a2 2 0 0 0-2-2h-4"/>
              <path d="M3 15v4a2 2 0 0 0 2 2h4"/>
              <path d="M21 15v4a2 2 0 0 1-2 2h-4"/>
            </svg>
          </button>
        </div>
      </div>
      <div class="plot">
        <canvas id="octCanvas"></canvas>
      </div>
    </div>

    <!-- Spectrogram -->
    <div class="card" id="heatCard">
      <div class="row" style="justify-content:space-between; align-items:center">
        <div class="row">
          <b>Spectrogram</b>
        </div>
        <div class="toolbar">
          <button class="ghost icon-btn fs-btn" title="Fullscreen" aria-label="Fullscreen">
            <svg class="icon" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2"
                 stroke-linecap="round" stroke-linejoin="round">
              <path d="M3 9V5a2 2 0 0 1 2-2h4"/>
              <path d="M21 9V5a2 2 0 0 0-2-2h-4"/>
              <path d="M3 15v4a2 2 0 0 0 2 2h4"/>
              <path d="M21 15v4a2 2 0 0 1-2 2h-4"/>
            </svg>
          </button>
        </div>
      </div>
      <div class="plot">
        <canvas id="heatCanvas"></canvas>
      </div>
    </div>

    <!-- dB meter (just for layout check) -->
    <div class="card">
      <div class="row" style="justify-content:space-between; align-items:center">
        <b>ความดังรวม dB (layout)</b>
        <span class="badge">AVG: — | MAX: —</span>
      </div>
      <div class="plot" style="height:120px">
        <canvas id="dbCanvas"></canvas>
      </div>
    </div>

  </div>

  <script>
    // ------- helpers
    const dpr = Math.max(1, Math.min(window.devicePixelRatio || 1, 2));

    function sizeCanvas(canvas){
      const rect = canvas.getBoundingClientRect();
      const w = Math.max(1, Math.floor(rect.width  * dpr));
      const h = Math.max(1, Math.floor(rect.height * dpr));
      if (canvas.width !== w || canvas.height !== h){
        canvas.width = w; canvas.height = h;
      }
    }

    function drawGrid(canvas, label){
      sizeCanvas(canvas);
      const ctx = canvas.getContext('2d');
      const w = canvas.width, h = canvas.height;
      ctx.save();
      ctx.clearRect(0,0,w,h);

      // background
      ctx.fillStyle = getComputedStyle(document.documentElement).getPropertyValue('--bg2') || '#1E293B';
      ctx.fillRect(0,0,w,h);

      // grid
      ctx.strokeStyle = 'rgba(255,255,255,.08)';
      ctx.lineWidth = Math.max(1, dpr*0.5);
      const cols = 12, rows = 8;
      for(let i=0;i<=cols;i++){
        const x = Math.round((i/cols)*w) + 0.5;
        ctx.beginPath(); ctx.moveTo(x,0); ctx.lineTo(x,h); ctx.stroke();
      }
      ctx.strokeStyle = 'rgba(255,255,255,.12)';
      for(let j=0;j<=rows;j++){
        const y = Math.round((j/rows)*h) + 0.5;
        ctx.beginPath(); ctx.moveTo(0,y); ctx.lineTo(w,y); ctx.stroke();
      }

      // edges to verify no clipping
      ctx.strokeStyle = '#22D3EE';
      ctx.lineWidth = Math.max(1.5, dpr);
      ctx.strokeRect(1,1,w-2,h-2);

      // corner ticks
      ctx.strokeStyle = '#A5B4FC';
      const L = Math.max(14, 8*dpr);
      ctx.beginPath();
      ctx.moveTo(1,1+L); ctx.lineTo(1,1); ctx.lineTo(1+L,1);
      ctx.moveTo(w-1,1+L); ctx.lineTo(w-1,1); ctx.lineTo(w-1-L,1);
      ctx.moveTo(1,h-1-L); ctx.lineTo(1,h-1); ctx.lineTo(1+L,h-1);
      ctx.moveTo(w-1,h-1-L); ctx.lineTo(w-1,h-1); ctx.lineTo(w-1-L,h-1);
      ctx.stroke();

      // label
      ctx.fillStyle = 'rgba(226,232,240,.9)';
      ctx.font = `${14*dpr}px/1.2 system-ui,-apple-system,Segoe UI,Roboto,"Noto Sans Thai",sans-serif`;
      ctx.fillText(label, 16*dpr, 22*dpr);

      ctx.restore();
    }

    function redrawAll(){
      drawGrid(document.getElementById('fftCanvas'), 'FFT');
      drawGrid(document.getElementById('octCanvas'), 'Octave');
      drawGrid(document.getElementById('heatCanvas'), 'Spectrogram');
      drawGrid(document.getElementById('dbCanvas'), 'dB meter');
    }

    // ------- Fullscreen handling (PWA-safe)
    function isStandalone(){
      return window.matchMedia('(display-mode: standalone)').matches || window.navigator.standalone === true;
    }

    function canUseFullscreenAPI(){
      // iOS Safari in PWA: no Fullscreen API. Fallback to .is-fullscreen
      return !!(document.fullscreenEnabled && Element.prototype.requestFullscreen);
    }

    function openFullscreenCard(card){
      // create close button (only once)
      if (!card.querySelector('.fs-close')){
        const btn = document.createElement('button');
        btn.className = 'fs-close';
        btn.innerHTML = `
          <svg viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2"
               stroke-linecap="round" stroke-linejoin="round" aria-hidden="true">
            <path d="M18 6L6 18M6 6l12 12"></path>
          </svg>`;
        btn.addEventListener('click', ()=> closeFullscreenCard(card));
        card.appendChild(btn);
      }

      if (canUseFullscreenAPI() && !isStandalone()){
        // Use real Fullscreen where available (not iPad PWA)
        card.requestFullscreen({navigationUI:'hide'}).catch(()=>{ /* fallback */ card.classList.add('is-fullscreen'); document.documentElement.classList.add('no-scroll'); redrawAll(); });
      }else{
        // PWA / iOS: fallback class with safe-area aware CSS
        card.classList.add('is-fullscreen');
        document.documentElement.classList.add('no-scroll');
        redrawAll();
      }
    }

    function closeFullscreenCard(card){
      card.classList.remove('is-fullscreen');
      document.documentElement.classList.remove('no-scroll');
      if (document.fullscreenElement) document.exitFullscreen().catch(()=>{});
      redrawAll();
    }

    function toggleFullscreenFromButton(btn){
      const card = btn.closest('.card');
      if (card.classList.contains('is-fullscreen') || document.fullscreenElement === card){
        closeFullscreenCard(card);
      }else{
        openFullscreenCard(card);
      }
    }

    // bind UI
    document.querySelectorAll('.fs-btn').forEach(btn=>{
      btn.addEventListener('click', ()=> toggleFullscreenFromButton(btn));
    });

    // Close on ESC or when user exits fullscreen
    document.addEventListener('keydown', (e)=>{
      if (e.key === 'Escape'){
        document.querySelectorAll('.card.is-fullscreen').forEach(closeFullscreenCard);
      }
    });
    document.addEventListener('fullscreenchange', ()=>{
      // when user exits via system gesture
      if (!document.fullscreenElement){
        document.documentElement.classList.remove('no-scroll');
      }
      redrawAll();
    });

    // handle resize / rotate
    window.addEventListener('resize', redrawAll, {passive:true});
    window.addEventListener('orientationchange', ()=> setTimeout(redrawAll, 60), {passive:true});

    // initial draw
    redrawAll();

    // Also redraw once after first layout settles (for iPad PWA rotation bars)
    setTimeout(redrawAll, 120);
  </script>
</body>
</html>
